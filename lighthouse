#!/usr/bin/env php
<?php
// Helper function to check if command exists
if (!function_exists('command_exists')) {
    function command_exists($command)
    {
        $return = shell_exec(sprintf("which %s", escapeshellarg($command)));
        return !empty($return);
    }
}

// Define root and database file
$root   = __DIR__;
$dbFile = "$root/database/database.sqlite";

// Check if we're running in a project directory or globally installed
$isGlobalInstall = !file_exists(__DIR__ . '/includes/config.php');

if (!$isGlobalInstall) {
    // Make sure database file exists
    if (!file_exists($dbFile)) {
        if (!is_dir(dirname($dbFile))) {
            mkdir(dirname($dbFile), 0777, true);
        }
        file_put_contents($dbFile, '');
    }

    require_once __DIR__ . '/includes/config.php';
    require_once __DIR__ . '/includes/db.php';
}

$argv = $_SERVER['argv'] ?? [];
$command = $argv[1] ?? null;
$subCommand = $argv[2] ?? null;

switch ($command) {

    // -------------------------
    // Database commands
    // -------------------------
    case 'db':
        switch ($subCommand) {
            case 'make:migration':
                $name = $argv[3] ?? null;
                if (!$name) exit("Migration name required.\n");
                $migrationDir = __DIR__ . '/database/migrations';
                if (!is_dir($migrationDir)) mkdir($migrationDir, 0777, true);
                $file = db_create_migration($name, $migrationDir);
                echo "Migration created: $file\n";
                break;

            case 'migrate':
                $migrationDir = __DIR__ . '/database/migrations';
                if (!is_dir($migrationDir)) exit("No migrations directory found.\n");
                db_migrate($migrationDir);
                echo "Migrations executed.\n";
                break;

            default:
                echo "Unknown db command: $subCommand\n";
                break;
        }
        break;

    // -------------------------
    // Test commands
    // -------------------------
    case 'test':
        switch ($subCommand) {
            case 'run':
                $runnerFile = __DIR__ . '/tests/run.php';
                if (!file_exists($runnerFile)) exit("Test runner not found: $runnerFile\n");

                require $runnerFile;
                break;

            default:
                echo "Unknown test command: $subCommand\n";
                break;
        }
        break;

    // -------------------------
    // Version command
    // -------------------------
    case 'version':
        if ($isGlobalInstall) {
            echo "0.4.0\n"; // Embedded version for global install
        } else {
            echo (string) (config('APP_VERSION') ?? 'dev') . "\n";
        }
        break;

    // -------------------------
    // New project scaffold
    // -------------------------
    case 'new':
        if (!$isGlobalInstall) {
            echo "Error: 'new' command is only available when lighthouse is globally installed.\n";
            echo "Use the install script to install lighthouse globally first.\n";
            exit(1);
        }

        $target = $subCommand ?: null;
        if (!$target) {
            echo "Project name or path required.\n";
            exit(1);
        }
        $targetPath = $target;
        if (file_exists($targetPath)) {
            echo "Target path already exists: $targetPath\n";
            exit(1);
        }

        // When globally installed, clone from GitHub
        if (!command_exists('git')) {
            echo "Error: git is required to create new projects.\n";
            exit(1);
        }

        $repoUrl = 'https://github.com/max-yterb/Lighthouse.git';
        $tempDir = sys_get_temp_dir() . '/lighthouse-new-' . uniqid();

        echo "Creating new project from repository...\n";
        exec("git clone --depth 1 '$repoUrl' '$tempDir' 2>&1", $output, $returnCode);

        if ($returnCode !== 0) {
            echo "Error: Failed to clone repository.\n";
            echo implode("\n", $output) . "\n";
            exit(1);
        }

        // Copy files excluding development files
        $exclude = ['.git', '.github', 'logs', 'database/database.sqlite', 'tests', 'vendor'];

        $rii = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($tempDir, FilesystemIterator::SKIP_DOTS), RecursiveIteratorIterator::SELF_FIRST);
        foreach ($rii as $item) {
            $rel = ltrim(str_replace($tempDir, '', $item->getPathname()), '/');
            $skip = false;
            foreach ($exclude as $ex) {
                if ($rel === $ex || str_starts_with($rel, rtrim($ex, '/') . '/')) {
                    $skip = true;
                    break;
                }
            }
            if ($skip) continue;
            $dest = rtrim($targetPath, '/') . '/' . $rel;
            if ($item->isDir()) {
                if (!is_dir($dest)) mkdir($dest, 0777, true);
            } else {
                if (!is_dir(dirname($dest))) mkdir(dirname($dest), 0777, true);
                copy($item->getPathname(), $dest);
            }
        }

        // Clean up temp directory
        exec("rm -rf '$tempDir'");

        // Remove any leftover database file
        if (file_exists($targetPath . '/database/database.sqlite')) {
            unlink($targetPath . '/database/database.sqlite');
        }

        // Copy .env.example to .env for a working project
        if (file_exists($targetPath . '/.env.example')) {
            copy($targetPath . '/.env.example', $targetPath . '/.env');
            echo "Copied .env.example to .env\n";
        }

        echo "Project created at $targetPath\n";
        echo "\nNext steps:\n";
        echo "  cd $targetPath\n";
        echo "  php -S localhost:8000 -t public/\n";
        break;

    default:
        if ($isGlobalInstall) {
            echo "Unknown command: $command\n";
            echo "Usage:\n";
            echo "  lighthouse version\n";
            echo "  lighthouse new PROJECT_NAME\n";
        } else {
            echo "Unknown command: $command\n";
            echo "Usage:\n";
            echo "  ./lighthouse db make:migration NAME\n";
            echo "  ./lighthouse db migrate\n";
            echo "  ./lighthouse test run\n";
            echo "  ./lighthouse version\n";
        }
        break;
}
