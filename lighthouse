#!/usr/bin/env php
<?php
// Define root and database file
$root   = __DIR__;
$dbFile = "$root/database/database.sqlite";

// Make sure database file exists
if (!file_exists($dbFile)) {
    if (!is_dir(dirname($dbFile))) {
        mkdir(dirname($dbFile), 0777, true);
    }
    file_put_contents($dbFile, '');
}

require_once __DIR__ . '/includes/config.php';
require_once __DIR__ . '/includes/db.php';

$argv = $_SERVER['argv'] ?? [];
$command = $argv[1] ?? null;
$subCommand = $argv[2] ?? null;

switch ($command) {

    // -------------------------
    // Database commands
    // -------------------------
    case 'db':
        switch ($subCommand) {
            case 'make:migration':
                $name = $argv[3] ?? null;
                if (!$name) exit("Migration name required.\n");
                $migrationDir = __DIR__ . '/database/migrations';
                if (!is_dir($migrationDir)) mkdir($migrationDir, 0777, true);
                $file = db_create_migration($name, $migrationDir);
                echo "Migration created: $file\n";
                break;

            case 'migrate':
                $migrationDir = __DIR__ . '/database/migrations';
                if (!is_dir($migrationDir)) exit("No migrations directory found.\n");
                db_migrate($migrationDir);
                echo "Migrations executed.\n";
                break;

            default:
                echo "Unknown db command: $subCommand\n";
                break;
        }
        break;

    // -------------------------
    // Test commands
    // -------------------------
    case 'test':
        switch ($subCommand) {
            case 'run':
                $runnerFile = __DIR__ . '/tests/run.php';
                if (!file_exists($runnerFile)) exit("Test runner not found: $runnerFile\n");

                require $runnerFile;
                break;

            default:
                echo "Unknown test command: $subCommand\n";
                break;
        }
        break;

    // -------------------------
    // Version command
    // -------------------------
    case 'version':
        echo (string) (config('APP_VERSION') ?? 'dev') . "\n";
        break;

    // -------------------------
    // New project scaffold
    // -------------------------
    case 'new':
        $target = $subCommand ?: null;
        if (!$target) {
            echo "Project name or path required.\n";
            exit(1);
        }
        $targetPath = $target;
        if (file_exists($targetPath)) {
            echo "Target path already exists: $targetPath\n";
            exit(1);
        }
        $source = __DIR__;

        $exclude = [
            '.git',
            '.github',
            'logs',
            'database/database.sqlite',
            'tests',
            'vendor',
        ];

        $rii = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($source, FilesystemIterator::SKIP_DOTS), RecursiveIteratorIterator::SELF_FIRST);
        foreach ($rii as $item) {
            $rel = ltrim(str_replace($source, '', $item->getPathname()), '/');
            $skip = false;
            foreach ($exclude as $ex) {
                if ($rel === $ex || str_starts_with($rel, rtrim($ex, '/') . '/')) {
                    $skip = true;
                    break;
                }
            }
            if ($skip) continue;
            $dest = rtrim($targetPath, '/') . '/' . $rel;
            if ($item->isDir()) {
                if (!is_dir($dest)) mkdir($dest, 0777, true);
            } else {
                if (!is_dir(dirname($dest))) mkdir(dirname($dest), 0777, true);
                copy($item->getPathname(), $dest);
            }
        }
        if (file_exists($targetPath . '/database/database.sqlite')) {
            unlink($targetPath . '/database/database.sqlite');
        }
        echo "Project created at $targetPath\n";
        break;

    default:
        echo "Unknown command: $command\n";
        echo "Usage:\n";
        echo "  cli db make:migration NAME\n";
        echo "  cli db migrate\n";
        echo "  cli test run\n";
        echo "  cli version\n";
        echo "  cli new PATH\n";
        break;
}
